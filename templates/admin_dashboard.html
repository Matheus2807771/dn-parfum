<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin - Amakha Paris</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background: #0b1022; color: #fff; min-height: 100vh; }
.header { background: #141937; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b3055; }
.header h1 { font-size: 20px; color: #23c483; }
.header-links a { color: #888; text-decoration: none; margin-left: 20px; font-size: 14px; }
.header-links a:hover { color: #23c483; }
.container { max-width: 1400px; margin: 0 auto; padding: 30px; }
.tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
.tab-btn { padding: 12px 24px; background: #141937; border: 2px solid #2b3055; border-radius: 10px; color: #fff; cursor: pointer; font-size: 14px; }
.tab-btn.active { background: #23c483; color: #000; border-color: #23c483; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card { background: #141937; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
.card h2 { color: #23c483; font-size: 18px; margin-bottom: 20px; }
.form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
.form-group { flex: 1; min-width: 200px; }
.form-group label { display: block; margin-bottom: 8px; color: #ccc; font-size: 14px; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #2b3055; border-radius: 8px; background: #0b1022; color: #fff; font-size: 14px; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #23c483; }
.btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; }
.btn-primary { background: #23c483; color: #000; }
.btn-primary:hover { background: #1da86d; }
.btn-danger { background: #ff4444; color: #fff; }
.btn-warning { background: #ffaa00; color: #000; }
.btn-sm { padding: 8px 16px; font-size: 12px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
.kit-card, .perfume-row { background: #0b1022; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
.kit-info h3 { font-size: 16px; margin-bottom: 5px; }
.kit-info p { color: #23c483; font-size: 18px; font-weight: bold; }
.kit-actions { display: flex; gap: 8px; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #2b3055; }
th { color: #23c483; font-size: 14px; }
.status-ativo { color: #23c483; }
.status-inativo { color: #ff4444; }
.toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; color: #fff; font-weight: bold; display: none; z-index: 1000; }
.toast.success { background: #23c483; }
.toast.error { background: #ff4444; }
.search-box { margin-bottom: 20px; }
.search-box input { width: 100%; max-width: 400px; padding: 12px; border: 2px solid #2b3055; border-radius: 8px; background: #0b1022; color: #fff; }


.kit-card {
  background: linear-gradient(180deg,#0f1430,#0a1128);
  border: 1px solid #2b3055;
  border-radius: 18px;
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,.35);
  transition: .25s ease;
}

.kit-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 18px 35px rgba(0,0,0,.55);
  border-color: #23c483;
}

/* Header */

.kit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.kit-title {
  font-size: 16px;
  font-weight: bold;
}

.kit-badge {
  padding: 6px 10px;
  border-radius: 50px;
  font-size: 11px;
  font-weight: bold;
}

.kit-badge.ativo {
  background: #23c483;
  color: #000;
}

.kit-badge.inativo {
  background: #ffaa00;
  color: #000;
}

/* Preço */

.kit-price {
  font-size: 24px;
  color: #23c483;
  font-weight: bold;
  margin-top: 6px;
}

/* Rodapé com ações */

.kit-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 6px;
}

.kit-actions {
  display: flex;
  gap: 8px;
}

.btn-outline {
  background: transparent;
  border: 2px solid #2b3055;
  color: #cfd3ff;
}

.btn-outline:hover {
  border-color: #23c483;
  color: #23c483;
}


/* Estilos para Relatórios */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}
.stat-card { background: linear-gradient(135deg, #141937, #1a2147); border-radius: 15px; padding: 25px; text-align: center; border: 1px solid #2b3055; }
.stat-card.destaque {
  background: linear-gradient(135deg, #23c483, #1da86d);
  border: none;
  grid-column: 1 / -1; /* Destaque ocupa linha inteira */
}
.stat-card.destaque h3, .stat-card.destaque p { color: #000; }
.stat-card h3 { font-size: 32px; color: #23c483; margin-bottom: 5px; }
.stat-card p { color: #888; font-size: 14px; }
.chart-container { background: #141937; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
.chart-container h3 { color: #23c483; font-size: 16px; margin-bottom: 20px; }
.chart-wrapper { height: 300px; position: relative; }
.ranking-list { list-style: none; }
.ranking-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #0b1022; border-radius: 8px; margin-bottom: 8px; }
.ranking-list li .rank { background: #23c483; color: #000; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 12px; }
.ranking-list li .nome { flex: 1; }
.ranking-list li .qtd { color: #23c483; font-weight: bold; }
.pedidos-table { max-height: 400px; overflow-y: auto; }
.pedidos-table table { font-size: 13px; }
.status-pendente { color: #ffaa00; }
.status-confirmado { color: #23c483; }
.status-cancelado { color: #ff4444; }
.loading { text-align: center; padding: 40px; color: #888; }
.refresh-btn { background: #2b3055; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-left: 10px; }
.refresh-btn:hover { background: #3b4065; }
</style>
</head>
<body>

<div class="header">
  <h1>Painel Administrativo - Amakha Paris</h1>
  <div class="header-links">
    <a href="/" target="_blank">Ver Site</a>
    <a href="/admin/logout">Sair</a>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn" onclick="showTab('relatorios')">Relatórios</button>
    <button class="tab-btn active" onclick="showTab('kits')">Kits</button>
    <button class="tab-btn" onclick="showTab('perfumes')">Perfumes</button>
    <button class="tab-btn" onclick="showTab('config')">Configurações</button>
  </div>

  <!-- TAB RELATÓRIOS -->
  <div id="tab-relatorios" class="tab-content">
    <div class="card">
      <h2>Resumo de Vendas <button class="refresh-btn" onclick="carregarRelatorios()">Atualizar</button></h2>
      
      <div class="stats-grid">
        <div class="stat-card destaque">
          <h3 id="stat-valor-total">R$ 0,00</h3>
          <p>Faturamento Total</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-valor-mes">R$ 0,00</h3>
          <p>Faturamento do Mês</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-pedidos-mes">0</h3>
          <p>Pedidos do Mês</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-valor-hoje">R$ 0,00</h3>
          <p>Faturamento Hoje</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-pedidos-hoje">0</h3>
          <p>Pedidos Hoje</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-total-pedidos">0</h3>
          <p>Total de Pedidos</p>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="chart-container" style="flex:1;">
        <h3>Vendas dos Últimos 30 Dias</h3>
        <div class="chart-wrapper">
          <canvas id="chartVendas"></canvas>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="chart-container" style="flex:1;">
        <h3>Kits Mais Vendidos</h3>
        <div class="chart-wrapper">
          <canvas id="chartKits"></canvas>
        </div>
      </div>
      <div class="chart-container" style="flex:1;">
        <h3>Top 10 Perfumes Mais Vendidos</h3>
        <ul class="ranking-list" id="ranking-perfumes">
          <li class="loading">Carregando...</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <h2>Pedidos Recentes</h2>
      <div class="pedidos-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>Kit</th>
              <th>Cliente</th>
              <th>WhatsApp</th>
              <th>Cidade</th>
              <th>Valor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="lista-pedidos">
            <tr><td colspan="7" class="loading">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB KITS -->
  <div id="tab-kits" class="tab-content active">
    <div class="card">
      <h2>Gerenciar Kits</h2>
      <div class="card" style="background:#0b1022">
        <h3 style="margin-bottom:15px;font-size:16px;">Adicionar Novo Kit</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Quantidade de Perfumes</label>
            <input type="number" id="kit-quantidade" placeholder="Ex: 5">
          </div>
          <div class="form-group">
            <label>Preço (R$)</label>
            <input type="number" step="0.01" id="kit-preco" placeholder="Ex: 89.90">
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;">
            <button class="btn btn-primary" onclick="adicionarKit()">Adicionar Kit</button>
          </div>
        </div>
      </div>
      <div class="grid" id="lista-kits"></div>
    </div>
  </div>

  <!-- TAB PERFUMES -->
  <div id="tab-perfumes" class="tab-content">
    <div class="card">
      <h2>Gerenciar Perfumes</h2>
      <div class="card" style="background:#0b1022">
        <h3 style="margin-bottom:15px;font-size:16px;">Adicionar Novo Perfume</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Nome do Perfume</label>
            <input type="text" id="perfume-nome" placeholder="Ex: 521 VIP Rose">
          </div>
          <div class="form-group">
            <label>Categoria</label>
            <select id="perfume-categoria">
              <option value="Masculino">Masculino</option>
              <option value="Feminino">Feminino</option>
              <option value="Unissex">Unissex</option>
              <option value="Infantil">Infantil</option>
            </select>
          </div>
          <div class="form-group">
            <label>ML</label>
            <select id="perfume-ml">
              <option value="15ml">15ml</option>
              <option value="30ml">30ml</option>
              <option value="50ml">50ml</option>
              <option value="100ml">100ml</option>
            </select>
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;">
            <button class="btn btn-primary" onclick="adicionarPerfume()">Adicionar</button>
          </div>
        </div>
      </div>
      <div class="search-box">
        <input type="text" id="busca-perfume" placeholder="Buscar perfume..." onkeyup="filtrarPerfumes()">
      </div>
      <table>
        <thead>
          <tr><th>Nome</th><th>Categoria</th><th>ML</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody id="lista-perfumes"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB CONFIG -->
  <div id="tab-config" class="tab-content">
    <div class="card">
      <h2>Configurações Gerais</h2>
      <div class="card" style="background:#0b1022">
        <h3 style="margin-bottom:15px;font-size:16px;">Informações de Envio</h3>
        <div class="form-row">
          <div class="form-group">
            <label>CEP de Origem</label>
            <input type="text" id="config-cep" placeholder="00000000" value="{{ config.cep_origem }}">
          </div>
          <div class="form-group">
            <label>WhatsApp (com DDD)</label>
            <input type="text" id="config-whatsapp" placeholder="5519999999999" value="{{ config.whatsapp }}">
          </div>
        </div>
      </div>
      <div class="card" style="background:#0b1022">
        <h3 style="margin-bottom:15px;font-size:16px;">Segurança</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Nova Senha de Admin</label>
            <input type="password" id="config-senha" placeholder="Deixe em branco para manter">
          </div>
          <div class="form-group">
            <label>Confirmar Nova Senha</label>
            <input type="password" id="config-senha-confirm" placeholder="Confirme a nova senha">
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="salvarConfig()">Salvar Configurações</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let kitsData = {};
let perfumesData = [];
let chartVendas = null;
let chartKits = null;

function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
  
  if (tab === 'relatorios') {
    carregarRelatorios();
  }
}

function showToast(msg, type) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast ' + type;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function formatarMoeda(valor) {
  return 'R$ ' + (valor || 0).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// ================= RELATÓRIOS =================

async function carregarRelatorios() {
  carregarResumo();
  carregarKitsMaisVendidos();
  carregarPerfumesMaisVendidos();
  carregarVendasPorPeriodo();
  carregarPedidosRecentes();
}

async function carregarResumo() {
  try {
    const resp = await fetch('/api/admin/relatorios/resumo');
    const data = await resp.json();
    
    document.getElementById('stat-valor-total').textContent = formatarMoeda(data.valor_total || 0);
    document.getElementById('stat-total-pedidos').textContent = data.total_pedidos || 0;
    document.getElementById('stat-valor-mes').textContent = formatarMoeda(data.valor_mes || 0);
    document.getElementById('stat-pedidos-mes').textContent = data.pedidos_mes || 0;
    document.getElementById('stat-valor-hoje').textContent = formatarMoeda(data.valor_hoje || 0);
    document.getElementById('stat-pedidos-hoje').textContent = data.pedidos_hoje || 0;
  } catch (e) {
    console.error('Erro ao carregar resumo:', e);
  }
}

async function carregarKitsMaisVendidos() {
  try {
    const resp = await fetch('/api/admin/relatorios/kits-mais-vendidos');
    const data = await resp.json();
    
    const ctx = document.getElementById('chartKits').getContext('2d');
    
    if (chartKits) chartKits.destroy();
    
    chartKits = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => 'Kit ' + d.kit),
        datasets: [{
          label: 'Vendas',
          data: data.map(d => d.quantidade),
          backgroundColor: '#23c483',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#cfd3ff', stepSize: 1, precision: 0 }, grid: { color: 'rgba(160,180,220,0.25)' } },
          x: { ticks: { color: '#cfd3ff' }, grid: { display: false } }
        }
      }
    });
  } catch (e) {
    console.error('Erro ao carregar kits:', e);
  }
}

async function carregarPerfumesMaisVendidos() {
  try {
    const resp = await fetch('/api/admin/relatorios/perfumes-mais-vendidos');
    const data = await resp.json();
    
    const container = document.getElementById('ranking-perfumes');
    
    if (data.length === 0) {
      container.innerHTML = '<li class="loading">Nenhum dado disponível</li>';
      return;
    }
    
    container.innerHTML = data.slice(0, 10).map((p, i) => `
      <li>
        <span class="rank">${i + 1}</span>
        <span class="nome">${p.perfume}</span>
        <span class="qtd">${p.quantidade} un.</span>
      </li>
    `).join('');
  } catch (e) {
    console.error('Erro ao carregar perfumes:', e);
  }
}

async function carregarVendasPorPeriodo() {
  try {
    const resp = await fetch('/api/admin/relatorios/vendas-por-periodo');
    const data = await resp.json();
    
    const ctx = document.getElementById('chartVendas').getContext('2d');
    
    if (chartVendas) chartVendas.destroy();
    
    chartVendas = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => {
          const date = new Date(d.data);
          return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }),
        datasets: [{
          label: 'Faturamento (R$)',
          data: data.map(d => d.valor),
          borderColor: '#23c483',
          backgroundColor: 'rgba(35, 196, 131, 0.15)',
          fill: true,
          tension: 0.35,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#cfd3ff', stepSize: 1, precision: 0 }, grid: { color: 'rgba(160,180,220,0.25)' } },
          x: { ticks: { color: '#cfd3ff', maxRotation: 45 }, grid: { display: false } }
        }
      }
    });
  } catch (e) {
    console.error('Erro ao carregar vendas:', e);
  }
}

async function carregarPedidosRecentes() {
  try {
    const resp = await fetch('/api/admin/relatorios/pedidos-recentes');
    const data = await resp.json();
    
    const container = document.getElementById('lista-pedidos');
    
    if (data.length === 0) {
      container.innerHTML = '<tr><td colspan="7" class="loading">Nenhum pedido encontrado</td></tr>';
      return;
    }
    
    container.innerHTML = data.map(p => {
      const date = new Date(p.created_at);
      const dataFormatada = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const statusAtual = p.status || 'pendente';
      
      return `
        <tr>
          <td>#${p.id}</td>
          <td>${dataFormatada}</td>
          <td>Kit ${p.kit_quantidade}</td>
          <td>${p.cliente_nome || '-'}</td>
          <td>${p.cliente_cidade || '-'}/${p.cliente_uf || '-'}</td>
          <td>${formatarMoeda(p.valor_total || 0)}</td>
          <td>
            <select onchange="alterarStatus(${p.id}, this.value)">
              <option value="pendente"   ${statusAtual === 'pendente' ? 'selected' : ''}>Pendente</option>
              <option value="confirmado" ${statusAtual === 'confirmado' ? 'selected' : ''}>Confirmado</option>
              <option value="cancelado"  ${statusAtual === 'cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
          </td>
        </tr>
      `;
    }).join('');
  } catch (e) {
    console.error('Erro ao carregar pedidos:', e);
  }
}

async function carregarPedidosRecentes() {
  try {
    const resp = await fetch('/api/admin/relatorios/pedidos-recentes');
    const data = await resp.json();
    
    const container = document.getElementById('lista-pedidos');
    
    if (data.length === 0) {
      container.innerHTML =
        '<tr><td colspan="8" class="loading">Nenhum pedido encontrado</td></tr>';
      return;
    }
    
    container.innerHTML = data.map(p => {

      const date = new Date(p.created_at);
      const dataFormatada =
        date.toLocaleDateString('pt-BR') + ' ' +
        date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

      const statusAtual = p.status || 'pendente';

      /* ===========================
         TELEFONE + WHATSAPP LINK
      ============================ */
      const telRaw = (p.cliente_telefone || '').replace(/\D/g,'');

      const telFormatado =
        telRaw
          ? telRaw.replace(/(\d{2})(\d{2})(\d{4,5})(\d{4})/,
              '($1) $2 $3-$4')
          : '-';

      const linkWhatsapp =
        telRaw
          ? `<a href="https://wa.me/55${telRaw}"
                target="_blank"
                style="color:#23c483;font-weight:bold;text-decoration:none;">
                ${telFormatado}
             </a>`
          : '-';

      return `
        <tr>
          <td>#${p.id}</td>
          <td>${dataFormatada}</td>
          <td>Kit ${p.kit_quantidade}</td>
          <td>${p.cliente_nome || '-'}</td>

          <!-- COLUNA WHATSAPP -->
          <td>${linkWhatsapp}</td>

          <!-- COLUNA CIDADE CORRETA -->
          <td>${p.cliente_cidade || '-'} / ${p.cliente_uf || '-'}</td>

          <td>${formatarMoeda(p.valor_total || 0)}</td>

          <td>
            <select onchange="alterarStatus(${p.id}, this.value)">
              <option value="pendente"   ${statusAtual === 'pendente' ? 'selected' : ''}>Pendente</option>
              <option value="confirmado" ${statusAtual === 'confirmado' ? 'selected' : ''}>Confirmado</option>
              <option value="cancelado"  ${statusAtual === 'cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
          </td>
        </tr>
      `;
    }).join('');

  } catch (e) {
    console.error('Erro ao carregar pedidos:', e);
  }
}


// ================= KITS =================

async function carregarKits() {
  const resp = await fetch('/api/admin/kits');
  kitsData = await resp.json();
  renderKits();
}

function renderKits() {
  const container = document.getElementById('lista-kits');

  const sorted = Object.entries(kitsData)
    .sort((a,b) => parseInt(a[0]) - parseInt(b[0]));

  container.innerHTML = sorted.map(([qtd, info]) => {

    const statusTexto = info.ativo ? "Ativo" : "Inativo";
    const statusClasse = info.ativo ? "ativo" : "inativo";

    return `
      <div class="kit-card">

        <!-- HEADER -->
        <div class="kit-header">
          <div class="kit-title">
            Kit ${qtd} Perfumes
          </div>

          <span class="kit-badge ${statusClasse}">
            ${statusTexto}
          </span>
        </div>

        <!-- PREÇO -->
        <div class="kit-price">
          R$ ${info.preco.toFixed(2)}
        </div>

        <!-- FOOTER -->
        <div class="kit-footer">

          <button class="btn btn-outline"
            onclick="toggleKit('${qtd}')">
            ${info.ativo ? "Desativar" : "Ativar"}
          </button>

          <div class="kit-actions">

            <button class="btn btn-warning"
              onclick="editarKit('${qtd}')">
              Editar
            </button>

            <button class="btn btn-danger"
              onclick="excluirKit('${qtd}')">
              Excluir
            </button>

          </div>

        </div>
      </div>
    `;
  }).join('');
}


async function adicionarKit() {
  const qtd = document.getElementById('kit-quantidade').value;
  const preco = document.getElementById('kit-preco').value;
  if (!qtd || !preco) return showToast('Preencha todos os campos', 'error');
  
  await fetch('/api/admin/kits', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({quantidade: qtd, preco: parseFloat(preco)})
  });
  document.getElementById('kit-quantidade').value = '';
  document.getElementById('kit-preco').value = '';
  showToast('Kit adicionado!', 'success');
  carregarKits();
}

async function toggleKit(qtd) {
  const atual = kitsData[qtd].ativo;
  await fetch('/api/admin/kits/' + qtd, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ativo: !atual})
  });
  showToast('Status alterado!', 'success');
  carregarKits();
}

async function editarKit(qtd) {
  const novoPreco = prompt('Novo preço para Kit ' + qtd + ':', kitsData[qtd].preco);
  if (novoPreco) {
    await fetch('/api/admin/kits/' + qtd, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({preco: parseFloat(novoPreco)})
    });
    showToast('Kit atualizado!', 'success');
    carregarKits();
  }
}

async function excluirKit(qtd) {
  if (confirm('Excluir Kit ' + qtd + ' perfumes?')) {
    await fetch('/api/admin/kits/' + qtd, {method: 'DELETE'});
    showToast('Kit excluído!', 'success');
    carregarKits();
  }
}

// ================= PERFUMES =================

async function carregarPerfumes() {
  const resp = await fetch('/api/admin/perfumes');
  perfumesData = await resp.json();
  renderPerfumes();
}

function renderPerfumes(filtro = '') {
  const container = document.getElementById('lista-perfumes');
  const filtered = perfumesData.filter(p => p.nome.toLowerCase().includes(filtro.toLowerCase()));
  container.innerHTML = filtered.map(p => `
    <tr>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.ml}</td>
      <td class="${p.ativo !== false ? 'status-ativo' : 'status-inativo'}">${p.ativo !== false ? 'Ativo' : 'Inativo'}</td>
      <td>
        <button class="btn btn-sm ${p.ativo !== false ? 'btn-warning' : 'btn-primary'}" onclick="togglePerfume(${p.id})">${p.ativo !== false ? 'Desativar' : 'Ativar'}</button>
        <button class="btn btn-sm btn-warning" onclick="editarPerfume(${p.id})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="excluirPerfume(${p.id})">Excluir</button>
      </td>
    </tr>
  `).join('');
}

function filtrarPerfumes() {
  renderPerfumes(document.getElementById('busca-perfume').value);
}

async function adicionarPerfume() {
  const nome = document.getElementById('perfume-nome').value;
  const categoria = document.getElementById('perfume-categoria').value;
  const ml = document.getElementById('perfume-ml').value;
  if (!nome) return showToast('Digite o nome do perfume', 'error');
  
  await fetch('/api/admin/perfumes', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({nome, categoria, ml})
  });
  document.getElementById('perfume-nome').value = '';
  showToast('Perfume adicionado!', 'success');
  carregarPerfumes();
}

async function togglePerfume(id) {
  const p = perfumesData.find(x => x.id === id);
  await fetch('/api/admin/perfumes/' + id, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ativo: p.ativo === false})
  });
  showToast('Status alterado!', 'success');
  carregarPerfumes();
}

async function editarPerfume(id) {
  const p = perfumesData.find(x => x.id === id);
  const novoNome = prompt('Novo nome:', p.nome);
  if (novoNome) {
    await fetch('/api/admin/perfumes/' + id, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({nome: novoNome})
    });
    showToast('Perfume atualizado!', 'success');
    carregarPerfumes();
  }
}

async function excluirPerfume(id) {
  if (confirm('Excluir este perfume?')) {
    await fetch('/api/admin/perfumes/' + id, {method: 'DELETE'});
    showToast('Perfume excluído!', 'success');
    carregarPerfumes();
  }
}

// ================= CONFIG =================

async function salvarConfig() {
  const cep = document.getElementById('config-cep').value;
  const whatsapp = document.getElementById('config-whatsapp').value;
  const senha = document.getElementById('config-senha').value;
  const senhaConfirm = document.getElementById('config-senha-confirm').value;
  
  if (senha && senha !== senhaConfirm) {
    return showToast('Senhas não conferem!', 'error');
  }
  
  const data = {cep_origem: cep, whatsapp: whatsapp};
  if (senha) data.nova_senha = senha;
  
  await fetch('/api/admin/config', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  
  document.getElementById('config-senha').value = '';
  document.getElementById('config-senha-confirm').value = '';
  showToast('Configurações salvas!', 'success');
}

// Carregar dados ao iniciar
carregarKits();
carregarPerfumes();
</script>

</body>
</html>
